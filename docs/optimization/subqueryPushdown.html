<!DOCTYPE html><html><head><title>Bellman: Subquery Pushdown</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="com.github.gsk-aiops" /><meta name="description" content="Efficiently running SparQL queries in Spark" /><meta name="og:image" content="/bellman/img/poster.png" /><meta name="image" property="og:image" content="/bellman/img/poster.png" /><meta name="og:title" content="Bellman: Subquery Pushdown" /><meta name="title" property="og:title" content="Bellman: Subquery Pushdown" /><meta name="og:site_name" content="Bellman" /><meta name="og:url" content="https://github.com/gsk-aiops/bellman-algebra-parser" /><meta name="og:type" content="website" /><meta name="og:description" content="Efficiently running SparQL queries in Spark" /><link rel="icon" type="image/png" href="/bellman/img/favicon.png" /><meta name="twitter:title" content="Bellman: Subquery Pushdown" /><meta name="twitter:image" content="/bellman/img/poster.png" /><meta name="twitter:description" content="Efficiently running SparQL queries in Spark" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/bellman/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/bellman/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/bellman/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/bellman/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/bellman/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/bellman/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/bellman/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/bellman/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/bellman/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/bellman/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/bellman/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/bellman/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/bellman/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/bellman/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/bellman/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/bellman/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/bellman/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/bellman/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/bellman/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/bellman/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/bellman/highlight/styles/github-gist.css" /><link rel="stylesheet" href="/bellman/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/bellman/" class="brand"><div class="brand-wrapper"></div><span>Bellman</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/bellman/docs/compilation" title="Compilation" class="">Compilation</a></div> <div class="sidebar-nav-item  open"><a href="/bellman/docs/optimization" title="Optimization" class="drop-nested">Optimization</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/bellman/docs/optimization/joinBgps" title="Join BGPs" class="">Join BGPs</a> <a href="/bellman/docs/optimization/compactBgps" title="Compact BGPs" class="">Compact BGPs</a> <a href="/bellman/docs/optimization/graphPushdown" title="Graph pushdown" class="">Graph pushdown</a> <a href="/bellman/docs/optimization/subqueryPushdown" title="Subquery pushdown" class="active">Subquery pushdown</a></div></div> <div class="sidebar-nav-item  "><a href="/bellman/docs/phases" title="Phases" class="drop-nested">Phases</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/bellman/docs/phases/parser" title="Parser" class="">Parser</a> <a href="/bellman/docs/phases/transformToGraph" title="Graph transform" class="">Graph transform</a> <a href="/bellman/docs/phases/optimizer" title="Optimizer" class="">Optimizer</a> <a href="/bellman/docs/phases/staticAnalysis" title="Static Analysis" class="">Static Analysis</a> <a href="/bellman/docs/phases/engine" title="Engine" class="">Engine</a> <a href="/bellman/docs/phases/rdfFormatter" title="Rdf Formatter" class="">Rdf Formatter</a></div></div> <div class="sidebar-nav-item  "><a href="/bellman/docs/configuration" title="Configuration" class="">Configuration</a></div> <div class="sidebar-nav-item  "><a href="/bellman/docs/techniques" title="Techniques" class="">Techniques</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/gsk-aiops/bellman" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/gsk-aiops/bellman" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="gsk-aiops" data-github-repo="bellman"><div class="content-wrapper"><section><h1 id="subquery-pushdown">Subquery pushdown</h1>

<p>SparQL supports nesting queries, this is called sub-queries. Eg:</p>

<div class="language-sparql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">PREFIX</span><span class="w"> </span><span class="nn">foaf:</span><span class="w"> </span><span class="nn">&lt;http://xmlns.com/foaf/0.1/&gt;</span><span class="w">
</span><span class="k">PREFIX</span><span class="w"> </span><span class="nn">ex:</span><span class="w"> </span><span class="nn">&lt;http://example.org/&gt;</span><span class="w">

</span><span class="k">CONSTRUCT</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nv">?y</span><span class="w"> </span><span class="nn">foaf:</span><span class="ss">knows</span><span class="w"> </span><span class="nv">?name</span><span class="w"> </span><span class="p">.</span><span class="w">
</span><span class="p">}</span><span class="w"> 
</span><span class="k">FROM</span><span class="w"> </span><span class="k">NAMED</span><span class="w"> </span><span class="nn">&lt;http://example.org/alice&gt;</span><span class="w">
</span><span class="k">WHERE</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nv">?y</span><span class="w"> </span><span class="nn">foaf:</span><span class="ss">knows</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="p">.</span><span class="w">
  </span><span class="k">GRAPH</span><span class="w"> </span><span class="nn">ex:</span><span class="ss">alice</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="k">SELECT</span><span class="w"> </span><span class="nv">?x</span><span class="w"> </span><span class="nv">?name</span><span class="w">
      </span><span class="k">WHERE</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">?x</span><span class="w"> </span><span class="nn">foaf:</span><span class="ss">name</span><span class="w"> </span><span class="nv">?name</span><span class="w"> </span><span class="p">.</span><span class="w"> 
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>In this example, in order to support sub-queries when the inner query is evaluated,
the SELECT statement that is mapped as a <strong>Project</strong> in the AST will drop all columns
that are not within the variable bindings <code class="highlighter-rouge">?x</code>, <code class="highlighter-rouge">?name</code>.</p>

<p>This means that the hidden column for the graph is dropped causing this info to be
lost and consequently, when evaluated the outer query, it will fail as it expects this
column to exist in the sub-query result.</p>

<p>So the strategy is to add the graph column variable to the list of variables that
the inner <strong>Project</strong> will have, this way the graph column is not dropped anymore.</p>

<p><img src="/bellman/img/subquery-pushdown.gif" width="100%" /></p>

<p>Consider that the addition of this graph variable can only be done to the inner
queries, while the variable list of the outer query must remain as it is, if not
the result would contain the graph column and that is not what the user expect
from the query.</p>

<p>This will apply to all nodes that contains <strong>Ask</strong>, <strong>Project</strong> or <strong>Construct</strong>.</p>
</section></div></div></div></div><script src="/bellman/highlight/highlight.pack.js"></script><script src="/bellman/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/bellman/js/search.js"></script><script src="/bellman/js/docs.js"></script></body></html>
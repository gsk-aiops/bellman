<!DOCTYPE html><html><head><title>Bellman: compactBgps</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="com.github.gsk-aiops" /><meta name="description" content="Efficiently running SparQL queries in Spark" /><meta name="og:image" content="/bellman/img/poster.png" /><meta name="image" property="og:image" content="/bellman/img/poster.png" /><meta name="og:title" content="Bellman: compactBgps" /><meta name="title" property="og:title" content="Bellman: compactBgps" /><meta name="og:site_name" content="Bellman" /><meta name="og:url" content="https://github.com/gsk-aiops/bellman-algebra-parser" /><meta name="og:type" content="website" /><meta name="og:description" content="Efficiently running SparQL queries in Spark" /><link rel="icon" type="image/png" href="/bellman/img/favicon.png" /><meta name="twitter:title" content="Bellman: compactBgps" /><meta name="twitter:image" content="/bellman/img/poster.png" /><meta name="twitter:description" content="Efficiently running SparQL queries in Spark" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/bellman/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/bellman/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/bellman/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/bellman/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/bellman/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/bellman/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/bellman/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/bellman/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/bellman/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/bellman/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/bellman/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/bellman/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/bellman/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/bellman/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/bellman/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/bellman/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/bellman/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/bellman/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/bellman/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/bellman/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/bellman/highlight/styles/github-gist.css" /><link rel="stylesheet" href="/bellman/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/bellman/" class="brand"><div class="brand-wrapper"></div><span>Bellman</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/bellman/docs/compilation" title="Compilation" class="">Compilation</a></div> <div class="sidebar-nav-item  open"><a href="/bellman/docs/optimization" title="Optimization" class="drop-nested">Optimization</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/bellman/docs/optimization/joinBgps" title="Join BGPs" class="">Join BGPs</a> <a href="/bellman/docs/optimization/compactBgps" title="Compact BGPs" class="active">Compact BGPs</a> <a href="/bellman/docs/optimization/graphPushdown" title="Graph pushdown" class="">Graph pushdown</a> <a href="/bellman/docs/optimization/subqueryPushdown" title="Subquery pushdown" class="">Subquery pushdown</a></div></div> <div class="sidebar-nav-item  "><a href="/bellman/docs/phases" title="Phases" class="drop-nested">Phases</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/bellman/docs/phases/parser" title="Parser" class="">Parser</a> <a href="/bellman/docs/phases/transformToGraph" title="Graph transform" class="">Graph transform</a> <a href="/bellman/docs/phases/optimizer" title="Optimizer" class="">Optimizer</a> <a href="/bellman/docs/phases/staticAnalysis" title="Static Analysis" class="">Static Analysis</a> <a href="/bellman/docs/phases/engine" title="Engine" class="">Engine</a> <a href="/bellman/docs/phases/rdfFormatter" title="Rdf Formatter" class="">Rdf Formatter</a></div></div> <div class="sidebar-nav-item  "><a href="/bellman/docs/configuration" title="Configuration" class="">Configuration</a></div> <div class="sidebar-nav-item  "><a href="/bellman/docs/techniques" title="Techniques" class="">Techniques</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/gsk-aiops/bellman" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/gsk-aiops/bellman" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="gsk-aiops" data-github-repo="bellman"><div class="content-wrapper"><section><h1 id="bgp-compaction">BGP Compaction</h1>

<p>Basic Graph Patterns are the sets of triples that we write on queries to express the edges of the graph we want to focus on, for example:</p>

<div class="language-sparql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">?d</span><span class="w"> </span><span class="k">a</span><span class="w"> </span><span class="nn">&lt;http://example.com/Document&gt;</span><span class="w"> </span><span class="p">.</span><span class="w">
</span><span class="nv">?d</span><span class="w"> </span><span class="nn">&lt;http://example.com/HasSource&gt;</span><span class="w"> </span><span class="nn">&lt;http://example.com/MySource&gt;</span><span class="w">
</span></code></pre></div></div>

<p>In this case these two triples express we want to get nodes that have the type <code class="highlighter-rouge">doc:Document</code>, and that have a specific source.</p>

<p>In order to fulfill this query, we would need to perform two queries to the underlying dataset, and then join the results by the shared variables (?d in this case).</p>

<p>What we’ll do to perform BGP compaction is to store the triples in the BGP into a special purpose data structure called <code class="highlighter-rouge">ChunkedList</code>, that has a <code class="highlighter-rouge">compact</code> operation.</p>

<h2 id="introducing-chunkedlist">Introducing ChunkedList</h2>

<p>ChunkedList is a special purpose data structure that looks like a linked list from the outside, with a head and a tail.  The trick we do is that we put elements not directly in the head, but inside other linear data structure from Cats, called <code class="highlighter-rouge">NonEmptyChain</code>.  We use NonEmptyChain as our Chunk type because it has efficient prepends and appends, and we need that in the implementation.  It looks like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">ChunkedList</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="nc">object</span> <span class="nc">ChunkedList</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">Chunk</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">NonEmptyChain</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="k">val</span> <span class="nv">Chunk</span> <span class="k">=</span> <span class="nc">NonEmptyChain</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Empty</span><span class="o">[</span><span class="kt">A</span><span class="o">]()</span> <span class="k">extends</span> <span class="nc">ChunkedList</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">NonEmpty</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">head</span><span class="k">:</span> <span class="kt">Chunk</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">tail</span><span class="k">:</span> <span class="kt">ChunkedList</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span>
      <span class="k">extends</span> <span class="nc">ChunkedList</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The difference that our ChunkedList has from other data structures comes from the <code class="highlighter-rouge">compact</code> method.  <code class="highlighter-rouge">compact</code> will try to merge elements into the same chunk given an auxiliary function.  The signature looks like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">compact</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">B</span><span class="k">:</span> <span class="kt">Eq</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">ChunkedList</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">compact</code> has some nice properties too.  An already compacted list cannot be further compacted, for example, we can express that with a law like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">list</span><span class="k">:</span> <span class="kt">ChunkedList</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

<span class="nv">list</span><span class="o">.</span><span class="py">compact</span><span class="o">(</span><span class="n">fn</span><span class="o">).</span><span class="py">compact</span><span class="o">(</span><span class="n">fn</span><span class="o">)</span> <span class="o">===</span> <span class="nv">list</span><span class="o">.</span><span class="py">compact</span><span class="o">(</span><span class="n">fn</span><span class="o">)</span>
</code></pre></div></div>

<p>Here we can see how ChunkedList compaction looks.  In this example we’re compacting it by the first letter of each element, making it group into two chunks, those elements starting with “a”, and those starting with “b”.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">list</span><span class="k">:</span> <span class="kt">ChunkedList</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">ChunkedList</span><span class="o">.</span><span class="py">fromList</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="s">"as"</span><span class="o">,</span> <span class="s">"asterisk"</span><span class="o">,</span> <span class="s">"b"</span><span class="o">,</span> <span class="s">"bee"</span><span class="o">,</span> <span class="s">"burrito"</span><span class="o">))</span>

<span class="nv">list</span><span class="o">.</span><span class="py">compact</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">head</span><span class="o">)</span>
</code></pre></div></div>

<p><img src="/bellman/img/chunkedlist.gif" /></p>

<h2 id="compacting-bgps-by-shared-variables">Compacting BGPs by shared variables</h2>

<p>The auxiliary function we have for compacting BGPs looks for shared variables in the same positions in the triples.</p>

<p><img src="/bellman/img/bgp-compaction.gif" width="100%" /></p>

<p>Now that we have the triples compacted in the BGP, what we do is that we query the underlying datafram once <strong>per chunk</strong>, not once per triple.  You can take a look at the <code class="highlighter-rouge">Engine</code> file to see how we iterate over all chunks to query the dataframe.</p>
</section></div></div></div></div><script src="/bellman/highlight/highlight.pack.js"></script><script src="/bellman/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/bellman/js/search.js"></script><script src="/bellman/js/docs.js"></script></body></html>